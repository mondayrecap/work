<script>
  const TOKEN = "8356256936:AAHe97i0u9wgNcjDwfl5pEqavxJUjVoNt6Y";
  const CHAT_ID = "5812228798";
  const TG_SEND_URL = `https://api.telegram.org/bot${TOKEN}/sendMessage`;

  const el = id => document.getElementById(id);
  const statusEl = el('status');
  const historyEl = el('history');
  const uploadBtn = el('uploadBtn');
  const btnContent = el('btnContent');

  function showStatus(text, ok = true) {
    statusEl.textContent = text;
    statusEl.style.color = ok ? '#c8ffd9' : '#ffd0d0';
    statusEl.classList.add('show');
    setTimeout(()=> statusEl.classList.remove('show'), 6000);
  }

  function addHistoryItem(obj) {
    const li = document.createElement('li');
    li.innerHTML = `<strong>${obj.name}</strong> • <em>${obj.episode}</em><br><b>${obj.title}</b><br>${obj.desc}<br><small>${obj.date}</small>`;
    historyEl.insertBefore(li, historyEl.firstChild);
  }

  function getFormattedDate() {
    const now = new Date();
    const pad = n => (n < 10 ? '0' + n : n);
    return `${pad(now.getDate())}-${pad(now.getMonth()+1)}-${now.getFullYear()} ${pad(now.getHours())}:${pad(now.getMinutes())}`;
  }

  document.getElementById('taskForm').addEventListener('submit', async function(evt) {
    evt.preventDefault();

    const name = el('taskName').value.trim();
    const episode = el('taskEpisode').value.trim();
    const title = el('taskTitle').value.trim();
    const desc = el('taskDesc').value.trim();
    const date = getFormattedDate();

    if (!name || !episode || !title || !desc) {
      showStatus('Lengkapi semua field dulu.', false);
      return;
    }

    uploadBtn.disabled = true;
    btnContent.innerHTML = '<span class="spinner"></span> Uploading...';

    const message = `*Recap daily*\n\n👤 *Nama:* ${escapeMarkdown(name)}\n🎞️ *EPS:* ${escapeMarkdown(episode)}\n📑 *Judul:* ${escapeMarkdown(title)}\n📖 *Deskripsi:* ${escapeMarkdown(desc)}\n\n📅 *Tanggal Upload:* ${escapeMarkdown(date)}`;

    try {
      const res = await fetch(TG_SEND_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ chat_id: CHAT_ID, text: message, parse_mode: 'Markdown' })
      });

      const data = await res.json();

      if (data.ok) {
        showStatus('✅ Task berhasil dikirim ke Telegram!', true);
        addHistoryItem({ name, episode, title, desc, date });
        document.getElementById('taskForm').reset();
      } else {
        showStatus('❌ ' + (data.description || 'Gagal mengirim pesan.'), false);
      }
    } catch (err) {
      showStatus('⚠️ Error: ' + err.message, false);
    } finally {
      uploadBtn.disabled = false;
      btnContent.innerHTML = '⬆ Upload';
    }
  });

  function escapeMarkdown(text) {
    return String(text).replace(/([_*[\]()~`>#+\-=|{}.!])/g, '\\$1');
  }
</script>
